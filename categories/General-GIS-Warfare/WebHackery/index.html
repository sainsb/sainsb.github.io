<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WebHackery | </title>
  <meta name="author" content="Che Geovara">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
  <meta property="og:site_name" content="null"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.ico" rel="icon" type="image/x-ico">
  <link rel="alternate" href="/atom.xml" title="null" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  
</head>


<body>
  <header id="header" class="inner"><div class="alignleft">
  <img src='//sainsb.github.io/blog_logo.png' style='margin:15px;'/>
  <h2 class="subtitle"></h2>
</div>
<nav id="main-nav" class="alignright">
  <ul>
    
      <li><a href="http://sainsb.github.io">Home</a></li>
    
      <li><a href="http://sainsb.github.io/archives">Archives</a></li>
    
      <li><a href="http://sainsb.github.io/about">About</a></li>
    
      <li><a href="http://sainsb.github.io/atom.xml">RSS</a></li>
    
  </ul>
  <div class="clearfix"></div>
</nav>
<div class="clearfix"></div>
</header>
  <div id="content" class="inner">
    <div id="main-col" class="alignleft"><div id="wrapper">
<h2 class="archive-title category">WebHackery</h2>


  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2012-03-13T07:16:04.000Z"><a href="/2012/03/13/two-recent-blog-posts-i-really-like/">Mar 13 2012</a></time>
      
      
  
    <h1 class="title"><a href="/2012/03/13/two-recent-blog-posts-i-really-like/">Two recent blog posts I really like</a></h1>
  

    </header>
    <div class="entry">
      
        <p>Scott Hanselman on people in the trenches who don’t tweet, blog or get involved in user groups etc.<br><a href="http://www.hanselman.com/blog/DarkMatterDevelopersTheUnseen99.aspx" target="_blank" rel="external">Dark Matter Developers: The Unseen 99%</a></p>
<p>And John Sonmez on switching gears, I fully agree with his conclusion that <a href="http://simpleprogrammer.com/2012/03/10/switching-gears-is-grinding-gears/" target="_blank" rel="external">switching gears is grinding gears.</a></p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2011-11-19T01:16:46.000Z"><a href="/2011/11/18/sql-for-the-mobile-client/">Nov 18 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/11/18/sql-for-the-mobile-client/">SQL for the mobile client...</a></h1>
  

    </header>
    <div class="entry">
      
        <p>After the dev meetup last night and talking to Alan Laframboise about the dodgy future of Silverlight, I’m feeling I must gel some thoughts here.</p>
<p>Silverlight is going away.  get used to it.</p>
<p>The thing I can’t figure out is why Microsoft is pushing HTML 5 so hard when their browser is the most pathetic supporter of it? I keep seeing crazy cool Google-centric HTML5 demos but I ain’t really seen shit from MS pushing the HTML5 envelope.</p>
<p><a href="http://www.theverge.com/2011/11/9/2548975/microsoft-may-halt-development-work-on-silverlight-after-next-release" target="_blank" rel="external">This article on the potential demise of Silverlight</a> after the next release had an interesting discussion thread….<br>This comment I found interesting:</p>
<blockquote>
<p>I haven’t really said anything that I was implying so I’ll say this, Apple had a hand in the advancement of HTML5 just as Google and Microsoft have. Apple refusing to support flash has helped increase the speed that HTML5 is developing and HTML5 replaces some uses of Silverlight but not all of them.<br>The reason MS would be likely to stop development of Silverlight after 5 is because the WinRT platform is a successor. It provides the functionality of Silverlight and incorporates HTML5+Javascript+CSS but still allows the use of C# or whatever supported language you prefer. Apple really had no hand in the replacement of Silverlight so that is why I question the statement “ Apple just took out two birds with one stone”</p>
</blockquote>
<p>Whoa, whoa whoa…the <strong>functionality of Silverlight</strong>? meaning? rich graphics engine?</p>
<p><strong>incorporates HTML5+Javascript+CSS</strong> (Oh good, because I just loooooove CSS)…can’t wait to get back to that bullshit.</p>
<p><strong>Still allows the use of C#</strong> - ok, this is the center of my relief and it continues to reinforce my belief that the lower you go, the less shit changes all the time….</p>
<p>Maybe I’ll just become a DBA…</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2011-06-22T06:33:00.000Z"><a href="/2011/06/21/php-token-proxy/">Jun 21 2011</a></time>
      
      
  
    <h1 class="title"><a href="/2011/06/21/php-token-proxy/">PHP Token Proxy</a></h1>
  

    </header>
    <div class="entry">
      
        <p>ArcGIS Server provides  proxy pages for multiple platforms <a href="http://resources.esri.com/help/9.3/arcgisserver/apis/javascript/arcgis/help/jshelp_start.htm#jshelp/ags_proxy.htm" target="_blank" rel="external">here</a>.  Strangely (or not), only the .NET version of their proxy page provides support for detecting tokens that have expired (and requesting new ones).  Since we needed a proxy page but run our external apps on the LAMP stack, I had to write a new one that detected stale tokens and requested new ones as needed.</p>
<p>The .NET version of this proxy stores the token in an HttpRuntime.Cache object property.  This isn’t really an option with PHP so I resorted to a simple file-based config file that gets edited when a new token is requested.</p>
<p>This isn’t rocket science but hopefully someone else out there can use this. (you’ll notice that I borrowed heavily from the proxy ESRI provided). Oh yeah, it uses an arbitrary referrer to request the token, and then repeats that referrer in requests.  The Apache user needs write access to the config file as well.</p>
<p>The core script:</p>
<pre lang="php">
<?php

include 'proxyConfig.php';

  $mustMatch = true; //Limit the proxy to only urls specified in proxyconfig
  $referrer = "myReferrer";  //this token proxy works off the referrer. (not IP)

  //Test whether or not the URL is allowed
  function is_url_allowed($allowedServers, $url) {
    $isOk = false;
    $url = trim($url, "\/");
    for ($i = 0, $len = count($allowedServers); $i < $len; $i++) {
      $value = $allowedServers[$i];
      $allowedUrl = trim($value['url'], "\/");
      if ($value['matchAll']) {
        if (stripos($url, $allowedUrl) === 0) {
          $isOk = $i; // array index that matched
          break;
        }
      }
      else {
        if ((strcasecmp($url, $allowedUrl) == 0)) {
          $isOk = $i; // array index that matched
          break;
        }
      }
    }
    return $isOk;
  }

  // Get the request URL
  $targetUrl = $_SERVER['QUERY_STRING'];

  // Have to decode it
  $targetUrl = urldecode($targetUrl);

  //If nothing is passed in
  if (!$targetUrl) {
    header('Status: 400', true, 400); // Bad Request
    echo 'Target URL is not specified! 
 Usage: 
 http://&lt;this-proxy-url&gt;?&lt;target-url&gt;';
    return;
  }

  $parts = preg_split("/\?/", $targetUrl);
  $targetPath = $parts[0];

  // check if the request URL matches any of the allowed URLs
  if ($mustMatch) {
    $pos = is_url_allowed($serverUrls, $targetPath);
    if ($pos === false) {
      header('Status: 403', true, 403); // Forbidden
      echo 'Target URL is not allowed! 
 Consult the documentation for this proxy to add the target URL to its Whitelist.';
      return;
    }
  }

  //check token
  $tokenTimeOut = $serverUrls[$pos]['tokenExpiration'];
  if(time()> $tokenTimeOut) //token fail
  {
     //construct token
    $Url= $serverUrls[$pos]['tokenSvc'] . "/?request=getToken";
    $Url .= "&username=" . $serverUrls[$pos]['user'];
    $Url .= "&password=" . $serverUrls[$pos]['password'];
    $Url .= "&expiration=" . $serverUrls[$pos]['tokenTime'];
    $Url .= "&clientid=ref." . $referrer;

    // CURL new token
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $Url);
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    $serverUrls[$pos]['token'] = curl_exec($ch);
    curl_close($ch);

    //Read in current config file into array
    $lines = file('proxyConfig.php');
    $new="";
     foreach($lines as $line)
    {
        if (preg_match("/'token'.\=\>/", $line))
        {
        $line="'token' => '" . (string)$serverUrls[$pos]['token'] . "',\n";
        }

        if (preg_match("/'tokenExpiration'.\=\>/", $line))
        {
        $line="'tokenExpiration' => " . (time()+($serverUrls[$pos]['tokenTime']*60)) . ",\n";
        }
        $new .= $line;
    }

    // Modify config file

    $fp=fopen("proxyConfig.php","w"); //or die("can't open file")
    fwrite($fp, $new);
   }

   // Assign token
   $token = $serverUrls[$pos]['token'];

    // Construct request URL with token
   $targetUrl .= (stripos($targetUrl, "?") !== false ? '&' : '?').'token='.$token;

  // open the curl session
  $session = curl_init();

  // set the appropriate options for this request
  $options = array(
    CURLOPT_URL => $targetUrl,
    CURLOPT_HEADER => false,
    CURLOPT_HTTPHEADER => array(
      'Content-Type: ' . $_SERVER['CONTENT_TYPE'],
      'Referer: ' .$referrer
    ),
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_SSL_VERIFYPEER => false
  );

  // put the POST data in the request body
  $postData = file_get_contents("php://input");
  if (strlen($postData) > 0) {
    $options[CURLOPT_POST] = true;
    $options[CURLOPT_POSTFIELDS] = $postData;
  }
  curl_setopt_array($session, $options);

  // make the call
  $response = curl_exec($session);
  $code = curl_getinfo($session, CURLINFO_HTTP_CODE);
  $type = curl_getinfo($session, CURLINFO_CONTENT_TYPE);
  curl_close($session);

  // set the proper Content-Type
  header("Status: ".$code, true, $code);
  header("Content-Type: ".$type);

  echo $response;
?>
</pre>

<p>The config include:</p>
<pre lang="php">
<?php
 $serverUrls = array(
array( 
'url' => 'https://sampleserver2.arcgisonline.com/ArcGIS/rest/services/',
'matchAll' => true,
'tokenSvc' => 'http://sampleserver2.arcgisonline.com/ArcGIS/tokens',
'token' => '',
'tokenTime' => 14400,
'tokenExpiration' => 1,
'user' => 'user',
'password' => 'pass'
));
?>
</pre>
      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  
    <article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
    <header>
      
        <div class="icon"></div>
        <time datetime="2010-12-16T23:32:44.000Z"><a href="/2010/12/16/a-few-thoughts-on-geojson/">Dec 16 2010</a></time>
      
      
  
    <h1 class="title"><a href="/2010/12/16/a-few-thoughts-on-geojson/">A few thoughts on geoJSON</a></h1>
  

    </header>
    <div class="entry">
      
        <p>I’ve noticed that the spec for EZRI’s JSON format as well as the more ‘open’ spec for geoJSON both have a weakness. And that weakness is a field mapping for each feature.  With ArcGIS we do not ever have a dataset with internally differing schema.</p>
<p><em>So when geoJSON goes like this:</em></p>
<pre lang="javascript">{ "type": "FeatureCollection",
  "features": [
    { "type": "Feature",
      "geometry": {"type": "Point", "coordinates": [102.0, 0.5]},
      "properties": {"prop0": "value0"}
      },
    { "type": "Feature",
      "geometry": {
        "type": "LineString",
        "coordinates": [
          [102.0, 0.0], [103.0, 1.0], [104.0, 0.0], [105.0, 1.0]
          ]
        },
      "properties": {
        "prop0": "value0",
        "prop1": 0.0
        }
      },
    { "type": "Feature",
       "geometry": {
         "type": "Polygon",
         "coordinates": [
           [ [100.0, 0.0], [101.0, 0.0], [101.0, 1.0],
             [100.0, 1.0], [100.0, 0.0] ]
           ]
       },
       "properties": {
         "prop0": "value0",
         "prop1": {"this": "that"}
         }
       }
     ]
   }</pre>
The prop0 and prop1 are redundant... in this case with a few features and abbreviated field names it is obviously no big deal.
The issue arrives when we want to load 250 features with 10, 10 character field names.  This amounts to 2490 redundant key entries for field names. Why?

_The same thing goes for EZRI's format:::_
<pre lang="javascript">
{"geometryType":"esriGeometryPoint",
"spatialReference":{"wkid":4326},
"features":[{"geometry":{"x":-83.1021268329999,"y":42.383135812,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Detroit"}},
{"geometry":{"x":-87.6850202569999,"y":41.837084233,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Chicago"}},
{"geometry":{"x":-73.9434298479999,"y":40.6699031900001,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"New York"}},
{"geometry":{"x":-75.1343024059999,"y":40.006932985,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Philadelphia"}},
{"geometry":{"x":-118.412114405,"y":34.112106538,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Los Angeles"}},
{"geometry":{"x":-117.136669444,"y":32.8149979820001,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"San Diego"}},
{"geometry":{"x":-96.7655292159999,"y":32.794279906,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Dallas"}},
{"geometry":{"x":-95.3869428549999,"y":29.7689275690001,
"spatialReference":{"wkid":4326}},
"attributes":{"CITY_NAME":"Houston"}}]}
</pre>

<p>In this case even more burdensome with the repeating spatialReference Key/Val per feature as well as the field mapping.</p>
<p>I propose a new JSON format.  One which more closely resembles a SQL statement without the field mappings.  Store field values in an array for each feature.</p>

      
    </div>
    <footer>
      
        
        
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>



  

  <nav id="pagination">
  
  
  <div class="clearfix"></div>
</nav>
</div></div>
    <aside id="sidebar" class="alignright">
  <div class="search">
  <form action="//google.com/search" method="get" accept-charset="utf-8">
    <input type="search" name="q" results="0" placeholder="Search">
    <input type="hidden" name="q" value="site:sainsb.github.io">
  </form>
</div>

  
<div class="widget tag">
  <h3 class="title">Categories</h3>
  <ul class="entry">
  
    <li><a href="/categories/ArcGIS-Server/">ArcGIS Server</a><small>32</small></li>
  
    <li><a href="/categories/C/">C#</a><small>2</small></li>
  
    <li><a href="/categories/CNET/">C#.NET</a><small>39</small></li>
  
    <li><a href="/categories/ArcGIS-Server/CNET/">C#.NET</a><small>5</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/">General GIS Warfare</a><small>80</small></li>
  
    <li><a href="/categories/ArcGIS-Server/General-GIS-Warfare/">General GIS Warfare</a><small>4</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/">General GIS Warfare</a><small>10</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Hardware/">Hardware</a><small>1</small></li>
  
    <li><a href="/categories/Hardware/">Hardware</a><small>6</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Oracle/">Oracle</a><small>2</small></li>
  
    <li><a href="/categories/Oracle/">Oracle</a><small>12</small></li>
  
    <li><a href="/categories/ArcGIS-Server/Python/">Python</a><small>1</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Python/">Python</a><small>3</small></li>
  
    <li><a href="/categories/CNET/Python/">Python</a><small>2</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/Python/">Python</a><small>2</small></li>
  
    <li><a href="/categories/Python/">Python</a><small>17</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/R/">R</a><small>1</small></li>
  
    <li><a href="/categories/CNET/Python/R/">R</a><small>1</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/R/">R</a><small>1</small></li>
  
    <li><a href="/categories/R/">R</a><small>7</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/RegEx/">RegEx</a><small>2</small></li>
  
    <li><a href="/categories/RegEx/">RegEx</a><small>3</small></li>
  
    <li><a href="/categories/CNET/RegEx/">RegEx</a><small>1</small></li>
  
    <li><a href="/categories/Snippets++/">Snippets++</a><small>21</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/R/Snippets++/">Snippets++</a><small>1</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/Snippets++/">Snippets++</a><small>2</small></li>
  
    <li><a href="/categories/CNET/Snippets++/">Snippets++</a><small>7</small></li>
  
    <li><a href="/categories/CNET/Python/Snippets++/">Snippets++</a><small>1</small></li>
  
    <li><a href="/categories/CNET/Python/R/Snippets++/">Snippets++</a><small>1</small></li>
  
    <li><a href="/categories/R/Snippets++/">Snippets++</a><small>3</small></li>
  
    <li><a href="/categories/Python/Snippets++/">Snippets++</a><small>3</small></li>
  
    <li><a href="/categories/ArcGIS-Server/Snippets++/">Snippets++</a><small>1</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Snippets++/">Snippets++</a><small>2</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/Python/Snippets++/">Snippets++</a><small>1</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Python/Snippets++/">Snippets++</a><small>2</small></li>
  
    <li><a href="/categories/Uncategorized/">Uncategorized</a><small>25</small></li>
  
    <li><a href="/categories/Snippets++/Uncategorized/">Uncategorized</a><small>1</small></li>
  
    <li><a href="/categories/CNET/Uncategorized/">Uncategorized</a><small>1</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/Uncategorized/">Uncategorized</a><small>1</small></li>
  
    <li><a href="/categories/Web-Hackery/">Web Hackery</a><small>5</small></li>
  
    <li><a href="/categories/ArcGIS-Server/WebHackery/">WebHackery</a><small>4</small></li>
  
    <li><a href="/categories/CNET/General-GIS-Warfare/WebHackery/">WebHackery</a><small>2</small></li>
  
    <li><a href="/categories/Snippets++/WebHackery/">WebHackery</a><small>2</small></li>
  
    <li><a href="/categories/CNET/Uncategorized/WebHackery/">WebHackery</a><small>1</small></li>
  
    <li><a href="/categories/WebHackery/">WebHackery</a><small>12</small></li>
  
    <li><a href="/categories/CNET/WebHackery/">WebHackery</a><small>3</small></li>
  
    <li><a href="/categories/General-GIS-Warfare/WebHackery/">WebHackery</a><small>4</small></li>
  
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Recent Posts</h3>
  <ul class="entry">
    
      <li>
        <a href="/2014/06/12/python-field-calculate-sequence/">Python field calculate sequence</a>
      </li>
    
      <li>
        <a href="/2014/05/19/erd-relationship-symbols/">ERD Relationship Symbols</a>
      </li>
    
      <li>
        <a href="/2014/05/08/positive-lookahead-assertion/">Positive lookahead assertion</a>
      </li>
    
      <li>
        <a href="/2014/04/22/python-iterate-files-weak-sauce/">Python iterate files (weak sauce)</a>
      </li>
    
      <li>
        <a href="/2014/04/21/python-cheats/">Python cheats</a>
      </li>
    
  </ul>
</div>


  
<div class="widget tag">
  <h3 class="title">Tags</h3>
  <ul class="entry">
  
    <li><a href="/tags/arcgis/">arcgis</a><small>1</small></li>
  
    <li><a href="/tags/arcpy/">arcpy</a><small>1</small></li>
  
    <li><a href="/tags/python/">python</a><small>1</small></li>
  
    <li><a href="/tags/regex/">regex</a><small>1</small></li>
  
  </ul>
</div>

</aside>
    <div class="clearfix"></div>
  </div>
  <footer id="footer" class="inner"><div class="alignleft">
  
  &copy; 2014 Che Geovara
  
</div>
<div class="clearfix"></div></footer>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>




<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>

</body>
</html>